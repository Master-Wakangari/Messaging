<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Chat</title>
<style>
body {
  font-family: 'Segoe UI', Roboto, sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f0f2f5;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

.chat-container {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
  max-width: 800px;
  margin: 0 auto;
  width: 100%;
  box-sizing: border-box;
}

.message-bubble {
  display: inline-block;
  padding: 12px 16px;
  border-radius: 18px;
  max-width: 75%;
  word-wrap: break-word;
  white-space: pre-wrap;
  font-size: 15px;
  line-height: 1.4;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  position: relative;
  animation: fadeIn 0.3s ease-out;
}

.user-message {
  background-color: #0084ff;
  color: white;
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}

.other-message {
  background-color: #e4e6eb;
  color: #050505;
  align-self: flex-start;
  border-bottom-left-radius: 4px;
}

.timestamp {
  font-size: 11px;
  color: #65676b;
  margin-top: 4px;
  text-align: right;
}

.loading {
  text-align: center;
  padding: 10px;
  color: #65676b;
}

.error-message {
  color: #ff4d4f;
  text-align: center;
  padding: 15px;
  background: white;
  border-radius: 8px;
  margin: 10px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.debug-info {
  font-size: 12px;
  color: #666;
  margin-top: 10px;
  word-break: break-all;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

.refresh-button {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #0084ff;
  color: white;
  border: none;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  font-size: 20px;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
}

.refresh-button:hover {
  background: #0073e6;
}

.refresh-button:disabled {
  background: #cccccc;
  cursor: not-allowed;
}
</style>
</head>
<body>

<div class="chat-container" id="chat">
  <div class="loading" id="loading">Loading messages...</div>
</div>

<button class="refresh-button" id="refreshButton" title="Refresh messages">↻</button>

<script>
// =============================================
// CONFIGURATION - MATCHES YOUR EXACT AIRTABLE
// =============================================
const config = {
  // Your Personal Access Token (regenerate after testing!)
  token: "patkXjCfAFHBuvUYA.d98b37c26061359b8c8cc6a8f96e5a829e46c72d929a465ffaae3b0a38317c1e",
  
  // From your Airtable URL (appXXXXXXXXXXXXXX)
  baseId: "appe1rfvfff2aF0pv",
  
  // Your exact table name
  tableName: "Messages",
  
  // Updated field mappings based on your screenshots
  fieldMappings: {
    content: "Message Content",               // Changed to show actual message content
    senderPair: "Sender-Recipient Pair", // Updated to match your exact field name
    date: "Sent Date",
    recipientId: "Recipient ID"
  },
  
  // Your user ID from the sender pair
  yourUserId: "6512199514",
  
  // Refresh settings
  refreshInterval: 5000, // 5 seconds
  maxRetries: 3,
  retryDelay: 2000
};

// =============================================
// APPLICATION CODE - NO CHANGES NEEDED BELOW
// =============================================
let lastFetchTime = 0;
let retryCount = 0;
let refreshIntervalId = null;

const chatContainer = document.getElementById("chat");
const loadingIndicator = document.getElementById("loading");
const refreshButton = document.getElementById("refreshButton");

function formatTimestamp(timestamp) {
  if (!timestamp) return '';
  const date = new Date(timestamp);
  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

async function fetchMessages() {
  try {
    loadingIndicator.style.display = 'block';
    
    const url = new URL(`https://api.airtable.com/v0/${config.baseId}/${encodeURIComponent(config.tableName)}`);
    url.searchParams.append('sort[0][field]', config.fieldMappings.date);
    url.searchParams.append('sort[0][direction]', 'asc');
    
    const response = await fetch(url, {
      headers: { 
        Authorization: `Bearer ${config.token}`,
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      let errorDetails = await response.text();
      try {
        errorDetails = JSON.parse(errorDetails).error?.message || errorDetails;
      } catch (e) {
        console.warn("Couldn't parse error response");
      }
      throw new Error(`HTTP ${response.status}: ${response.statusText}\nDetails: ${errorDetails}`);
    }
    
    const data = await response.json();
    console.log("API Success:", data.records?.length, "messages loaded");
    lastFetchTime = Date.now();
    retryCount = 0;
    return data.records;
    
  } catch (error) {
    console.error('Fetch Error:', error);
    retryCount++;
    
    if (retryCount <= config.maxRetries) {
      console.log(`Retrying in ${config.retryDelay/1000} seconds... (${retryCount}/${config.maxRetries})`);
      await new Promise(resolve => setTimeout(resolve, config.retryDelay));
      return fetchMessages();
    }
    throw error;
  } finally {
    loadingIndicator.style.display = 'none';
  }
}

function renderMessages(messages) {
  if (!messages || messages.length === 0) {
    chatContainer.innerHTML = '<div class="error-message">No messages found.</div>';
    return;
  }

  const fragment = document.createDocumentFragment();
  
  messages.forEach(record => {
    const messageDiv = document.createElement("div");
    messageDiv.classList.add("message-bubble");
    
    // Get message content from the correct field
    const messageText = record.fields[config.fieldMappings.content] || "(No content)";
    messageDiv.textContent = messageText;
    
    // Determine sender
    const senderPair = record.fields[config.fieldMappings.senderPair] || "";
    const isYou = senderPair.includes(config.yourUserId);
    messageDiv.classList.add(isYou ? "user-message" : "other-message");
    
    // Add timestamp if available
    const timestamp = record.fields[config.fieldMappings.date] || record.createdTime;
    if (timestamp) {
      const timeElement = document.createElement("div");
      timeElement.classList.add("timestamp");
      timeElement.textContent = formatTimestamp(timestamp);
      messageDiv.appendChild(timeElement);
    }
    
    fragment.appendChild(messageDiv);
  });
  
  chatContainer.innerHTML = '';
  chatContainer.appendChild(fragment);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

function handleError(error) {
  console.error('Error:', error);
  
  let errorMessage = 'Error loading messages. Please try again later.';
  let debugInfo = '';
  
  if (error.message.includes('403')) {
    errorMessage = 'Access Denied (403 Forbidden)';
    debugInfo = `
      <div class="debug-info">
        <strong>Possible causes:</strong>
        <ul>
          <li>Invalid Personal Access Token</li>
          <li>Token missing required scopes</li>
          <li>Incorrect base ID or table name</li>
        </ul>
        <strong>Current config:</strong><br>
        Base: ${config.baseId}<br>
        Table: ${config.tableName}
      </div>
    `;
  } else if (error.message.includes('422')) {
    errorMessage = 'Data Validation Error (422)';
    debugInfo = `
      <div class="debug-info">
        <strong>Field Mappings:</strong><br>
        Content: ${config.fieldMappings.content}<br>
        Sender: ${config.fieldMappings.senderPair}<br>
        Date: ${config.fieldMappings.date}<br>
        <strong>Verify these match your Airtable fields exactly</strong>
      </div>
    `;
  }
  
  chatContainer.innerHTML = `
    <div class="error-message">
      ${errorMessage}
      <br><br>
      <strong>Details:</strong><br>
      ${error.message.split('\n')[0]}
      ${debugInfo}
    </div>
  `;
}

async function loadMessages() {
  try {
    const messages = await fetchMessages();
    renderMessages(messages);
  } catch (error) {
    handleError(error);
  }
}

function setupAutoRefresh() {
  if (refreshIntervalId) clearInterval(refreshIntervalId);
  refreshIntervalId = setInterval(loadMessages, config.refreshInterval);
}

refreshButton.addEventListener('click', async () => {
  refreshButton.disabled = true;
  refreshButton.textContent = '...';
  try {
    await loadMessages();
  } finally {
    refreshButton.disabled = false;
    refreshButton.textContent = '↻';
  }
});

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  loadMessages();
  setupAutoRefresh();
});

window.addEventListener('beforeunload', () => {
  if (refreshIntervalId) clearInterval(refreshIntervalId);
});
</script>
</body>
</html>
